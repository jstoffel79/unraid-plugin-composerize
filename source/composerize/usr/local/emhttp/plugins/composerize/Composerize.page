---
Title="Composerize"
Icon="composerize.png"
Type="xmenu"
Menu="Utilities"
---
<?php
// Copyright 2022, ibay70
// This code is licensed under the MIT license (see LICENSE.md for details)
// Updated by Gemini for Unraid 7.1.4+ compatibility, theming, and bug fixes.

define('PLUGIN_ROOT', '/plugins/composerize');
define('PLUGIN_API_URL', PLUGIN_ROOT . '/api.php');

// Suppress errors and try to include
$templates = [];
try {
    @require_once '/usr/local/emhttp' . PLUGIN_ROOT . '/include/composerize.php';
    if (function_exists('getDockerTemplateList')) {
        $templates = getDockerTemplateList();
    }
} catch (Throwable $e) {
    error_log("Composerize Plugin Error: " . $e->getMessage());
}
?>

<link type="text/css" rel="stylesheet" href="<?autov('/webGui/styles/jquery.ui.css')?>">
<link type="text/css" rel="stylesheet" href="<?autov('/plugins/dynamix/styles/dropdownchecklist.css')?>">
<style>
/* Unraid-compatible styles */
.composerize-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.composerize-panel {
    background: rgba(var(--accent-bg), 0.33);
    border: 1px solid rgba(var(--accent-bg), 0.5);
    border-radius: 5px;
    padding: 20px;
    margin-bottom: 20px;
}

.composerize-panel h3 {
    margin-top: 0;
    color: var(--text-bright);
    border-bottom: 1px solid rgba(var(--accent-bg), 0.5);
    padding-bottom: 10px;
}

select, textarea, button {
    font-family: inherit;
    font-size: 13px;
}

#template-select {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
}

#compose-text {
    width: 100%;
    height: 400px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    padding: 10px;
    border: 1px solid #ccc;
    resize: vertical;
}

.button-group {
    margin-top: 15px;
}

.button-group button {
    margin-right: 10px;
    padding: 8px 16px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}

#submit-button {
    background: #4a90e2;
    color: white;
}

#submit-button:hover:not(:disabled) {
    background: #357abd;
}

#submit-button:disabled {
    background: #ccc;
    cursor: not-allowed;
}

#undo-button {
    background: #f5a623;
    color: white;
}

#undo-button:hover:not(:disabled) {
    background: #e6941a;
}

#reset-button {
    background: #d0021b;
    color: white;
}

#reset-button:hover {
    background: #b8021a;
}

#remove-container-button {
    background: #ff6b35;
    color: white;
}

#remove-container-button:hover:not(:disabled) {
    background: #e55a2b;
}

#remove-container-button:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.form-options {
    background: rgba(var(--accent-bg), 0.15);
    border: 1px solid rgba(var(--accent-bg), 0.3);
    border-radius: 3px;
    padding: 15px;
}

.form-options label {
    cursor: pointer;
    user-select: none;
}

#status-message {
    padding: 10px;
    margin: 10px 0;
    border-radius: 3px;
    display: none;
    text-align: center;
}

#status-message.success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

#status-message.error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}
</style>

<div class="composerize-container">
    <div class="composerize-panel">
        <h3>Select a Running Container Template</h3>
        <select id="template-select">
            <option value="" selected>Choose a template...</option>
            <?php foreach ($templates as $name => $command): ?>
                <option value="<?= htmlspecialchars($command); ?>"><?= htmlspecialchars($name); ?></option>
            <?php endforeach; ?>
        </select>
        <?php if (empty($templates)): ?>
            <p><em>No running container templates found. Make sure you have Docker containers running and templates available.</em></p>
        <?php else: ?>
            <p>Found <?= count($templates); ?> running container templates.</p>
        <?php endif; ?>
    </div>
    
    <div class="composerize-panel">
        <h3>Docker Compose Preview</h3>
        <form id="compose-form">
            <textarea id="compose-text" name="compose" spellcheck="false" placeholder="Select a template above to generate Docker Compose YAML..."></textarea>
            <input type="hidden" id="stack-name" name="name" value="">
            
            <div id="status-message"></div>
            
            <div class="form-options" style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" id="auto-remove" style="margin-right: 8px;">
                    Automatically remove existing Docker container when applying stack
                </label>
                <label style="display: block;">
                    <input type="checkbox" id="force-install" style="margin-right: 8px;">
                    Force overwrite existing compose stack
                </label>
            </div>
            
            <div class="button-group">
                <button type="submit" id="submit-button" disabled>Apply Stack</button>
                <button type="button" id="remove-container-button" disabled>Remove Container Only</button>
                <button type="button" id="undo-button" disabled>Revert Changes</button>
                <button type="button" id="reset-button">Reset</button>
            </div>
        </form>
    </div>
</div>

<script src="<?= htmlspecialchars(PLUGIN_ROOT); ?>/js/composerize.min.js"></script>
<script>
$(function() {
    // Wait for both jQuery and composerize to be ready
    if (typeof composerize !== 'function') {
        console.error('composerize function not available');
        $('#status-message').text('Error: composerize library not loaded').addClass('error').show();
        return;
    }

    var originalCompose = '';
    var currentContainerName = '';
    var $templateSelect = $('#template-select');
    var $composeText = $('#compose-text');
    var $submitButton = $('#submit-button');
    var $removeContainerButton = $('#remove-container-button');
    var $undoButton = $('#undo-button');
    var $resetButton = $('#reset-button');
    var $stackNameInput = $('#stack-name');
    var $autoRemove = $('#auto-remove');
    var $forceInstall = $('#force-install');
    var $form = $('#compose-form');
    var $statusMessage = $('#status-message');

    function showStatus(message, type) {
        type = type || 'success';
        $statusMessage.removeClass('success error').addClass(type).text(message).show();
        setTimeout(function() {
            $statusMessage.fadeOut();
        }, 5000);
    }

    function handleApply(event) {
        event.preventDefault();
        var name = $stackNameInput.val();
        var compose = $composeText.val();

        if (!name || !compose) {
            showStatus('Please select a template first.', 'error');
            return;
        }

        $submitButton.prop('disabled', true).text('Processing...');

        // Function to install the stack
        function installStack() {
            $.ajax({
                url: "<?= htmlspecialchars(PLUGIN_API_URL); ?>",
                method: 'POST',
                data: {
                    name: name,
                    compose: compose,
                    force: $forceInstall.is(':checked') ? 'true' : 'false'
                },
                timeout: 30000
            })
            .done(function(data) {
                showStatus(data, 'success');
                // Refresh the page to update the template list
                setTimeout(function() {
                    location.reload();
                }, 2000);
            })
            .fail(function(xhr) {
                var errorMsg = xhr.responseText || 'Unknown error occurred';
                console.error('Error applying compose stack:', errorMsg);
                showStatus('Error: ' + errorMsg, 'error');
            })
            .always(function() {
                $submitButton.prop('disabled', false).text('Apply Stack');
            });
        }

        // Check if we should remove the container first
        if ($autoRemove.is(':checked') && currentContainerName) {
            $submitButton.text('Removing Container...');
            
            $.ajax({
                url: "<?= htmlspecialchars(PLUGIN_ROOT); ?>/remove_container.php",
                method: 'POST',
                data: {
                    container_name: currentContainerName
                },
                timeout: 30000
            })
            .done(function(data) {
                showStatus('Container removed: ' + data, 'success');
                // Wait a moment then install the stack
                setTimeout(installStack, 1000);
            })
            .fail(function(xhr) {
                var errorMsg = xhr.responseText || 'Failed to remove container';
                console.error('Error removing container:', errorMsg);
                showStatus('Error removing container: ' + errorMsg, 'error');
                $submitButton.prop('disabled', false).text('Apply Stack');
            });
        } else {
            // Just install the stack
            installStack();
        }
    }

    function removeContainerOnly() {
        if (!currentContainerName) {
            showStatus('No container selected.', 'error');
            return;
        }

        if (!confirm('Are you sure you want to remove the container "' + currentContainerName + '"? This cannot be undone.')) {
            return;
        }

        $removeContainerButton.prop('disabled', true).text('Removing...');

        $.ajax({
            url: "<?= htmlspecialchars(PLUGIN_ROOT); ?>/remove_container.php",
            method: 'POST',
            data: {
                container_name: currentContainerName
            },
            timeout: 30000
        })
        .done(function(data) {
            showStatus('Container removed: ' + data, 'success');
            // Refresh the page to update the template list
            setTimeout(function() {
                location.reload();
            }, 2000);
        })
        .fail(function(xhr) {
            var errorMsg = xhr.responseText || 'Unknown error occurred';
            console.error('Error removing container:', errorMsg);
            showStatus('Error: ' + errorMsg, 'error');
        })
        .always(function() {
            $removeContainerButton.prop('disabled', false).text('Remove Container Only');
        });
    }

    $form.on('submit', handleApply);
    $removeContainerButton.on('click', removeContainerOnly);

    $templateSelect.on('change', function() {
        var selectedOption = this.options[this.selectedIndex];
        var command = selectedOption.value;
        
        if (command) {
            currentContainerName = selectedOption.text;
            
            try {
                originalCompose = composerize(command);
                $composeText.val(originalCompose);
                $stackNameInput.val(selectedOption.text);
                $submitButton.prop('disabled', false);
                $removeContainerButton.prop('disabled', false);
                $undoButton.prop('disabled', false);
                $statusMessage.hide();
            } catch (e) {
                console.error('Conversion error:', e);
                showStatus('Error generating compose: ' + e.message, 'error');
                originalCompose = '';
                $composeText.val('Could not parse the docker run command for this template.\n\n' + command);
                $submitButton.prop('disabled', true);
                $removeContainerButton.prop('disabled', true);
                $undoButton.prop('disabled', true);
            }
        } else {
            currentContainerName = '';
            originalCompose = '';
            $composeText.val('');
            $stackNameInput.val('');
            $submitButton.prop('disabled', true);
            $removeContainerButton.prop('disabled', true);
            $undoButton.prop('disabled', true);
            $statusMessage.hide();
        }
    });

    $undoButton.on('click', function() {
        $composeText.val(originalCompose);
    });

    $resetButton.on('click', function() {
        $templateSelect.prop('selectedIndex', 0).trigger('change');
    });
});
</script>
